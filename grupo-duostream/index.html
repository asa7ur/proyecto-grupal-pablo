<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti칩n de Guardias</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #334155; --text-light: #64748b; --border: #e2e8f0; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 80px; }
        header { background-color: var(--card-bg); padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 600; }
        .subtitle { font-size: 0.875rem; color: var(--text-light); }
        .fecha-badge { background-color: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 99px; font-size: 0.9rem; font-weight: 500; }
        .main-container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .dia-section { margin-bottom: 2rem; }
        .dia-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); margin: 1rem 0; }
        .table-header { display: grid; grid-template-columns: 35% 65%; gap: 1.5rem; margin-bottom: 1rem; padding: 0 1rem; }
        .col-title { font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.85rem; color: var(--text-light); }
        .hora-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 1.5rem; display: grid; grid-template-columns: 35% 65%; overflow: hidden; border: 1px solid var(--border); }
        .col-guardias { background-color: #f8fafc; padding: 1.5rem; border-right: 1px solid var(--border); }
        .hora-badge { display: inline-flex; align-items: center; background-color: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .hora-rango { font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem; display: block; }
        .lista-profes { list-style: none; padding: 0; margin: 0; }
        .profe-item { display: flex; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .profe-item:last-child { border-bottom: none; }
        .profe-icon { margin-right: 0.75rem; color: var(--text-light); }
        .aula-tag { font-size: 0.8rem; background: #e2e8f0; color: var(--text-main); padding: 2px 6px; border-radius: 4px; margin-left: auto; }
        .btn-add-guardia { margin-top: 10px; font-size: 0.8rem; color: var(--accent); background: none; border: 1px dashed var(--accent); padding: 5px 10px; border-radius: 4px; cursor: pointer; width: 100%; text-align: center; transition: all 0.2s; }
        .btn-add-guardia:hover { background: #eff6ff; }
        .col-ausencias { padding: 1.5rem; background-color: var(--card-bg); min-height: 150px; }
        .empty-state { color: #cbd5e1; font-style: italic; text-align: center; margin-top: 2rem; font-size: 0.9rem; }
        .task-card { background-color: #fff; border: 1px solid var(--border); border-left: 4px solid var(--danger); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02); transition: transform 0.2s; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        .task-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .task-profe { font-weight: 600; color: var(--danger); }
        .task-meta { font-size: 0.85rem; color: var(--text-light); background: #fee2e2; padding: 2px 8px; border-radius: 4px; }
        .task-body { font-size: 0.95rem; line-height: 1.5; color: var(--text-main); }
        .fab { position: fixed; bottom: 2rem; right: 2rem; background-color: var(--accent); color: white; width: 64px; height: 64px; border-radius: 50%; border: none; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4); cursor: pointer; font-size: 2rem; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); background-color: #1d4ed8; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); z-index: 200; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 90%; max-width: 450px; padding: 2rem; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--primary); }
        label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-main); }
        input, select, textarea { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        input:focus, textarea:focus { outline: 2px solid var(--accent); border-color: transparent; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 0.75rem; border-radius: 8px; width: 100%; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: transparent; color: var(--text-light); border: 1px solid var(--border); padding: 0.75rem; border-radius: 8px; width: 100%; font-weight: 500; cursor: pointer; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Parte de Guardias</h1>
            <div class="subtitle">IES ALIXAR - Panel de Control Docente</div>
        </div>
        <div style="display:flex; gap:0.5rem; align-items:center;">
            <div class="fecha-badge" id="fecha-actual">Cargando fecha...</div>
            <div class="fecha-badge" id="tiempo-carga" style="background:#0ea5e9;">Cargando datos...</div>
        </div>
    </header>
    <div class="main-container">
        <div class="table-header">
            <div class="col-title">Profesores de Guardia</div>
            <div class="col-title">Registro de Ausencias y Tareas</div>
        </div>
        <div id="contenedor-filas">
            <div style="text-align:center; padding: 4rem; color: var(--text-light);">
                Conectando con Google Sheets...
            </div>
        </div>
    </div>
    <button class="fab" onclick="abrirModal('ausencia')" title="Comunicar Ausencia">+</button>
    
    <div class="modal-overlay" id="modal">
        <div class="modal-card">
            <h3 class="modal-title" id="modal-titulo">Nueva Entrada</h3>
            <input type="hidden" id="tipo-accion">
            <input type="hidden" id="hora-preseleccionada">
            <label>D칤a:</label>
            <select id="input-dia"></select>
            <label>Selecciona la Hora:</label>
            <select id="input-hora"></select>
            <label id="lbl-profe">Profesor:</label>
            <input type="text" id="input-nombre" placeholder="Nombre del docente">
            <div id="campos-ausencia">
                <label>Grupo / Aula:</label>
                <input type="text" id="input-ubicacion" placeholder="Ej: 2췈 ESO B - Aula 12">
                <label>Tarea para el alumnado:</label>
                <textarea id="input-tarea" rows="3" placeholder="Descripci칩n de la tarea..."></textarea>
            </div>
            <div id="campos-guardia" style="display:none;">
                <label>Ubicaci칩n de Guardia:</label>
                <input type="text" id="input-lugar-guardia" placeholder="Ej: Biblioteca, Pasillo...">
            </div>
            <button class="btn-primary" onclick="guardarDatos()">Guardar</button>
            <button class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let datosHorario = {};
        let listaHoras = [];
        let listaDias = [];
        const ordenDias = ['Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado', 'Domingo'];
        const normalizarTexto = texto => texto.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        const obtenerClaveDia = dia => normalizarTexto(dia).replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        let tiempoInicioCarga = 0;

        // INICIALIZACI칍N
        window.onload = () => {
            const hoy = new Date();
            const opciones = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('fecha-actual').innerText = hoy.toLocaleDateString('es-ES', opciones);
            tiempoInicioCarga = performance.now();
            
            // LLAMADA A LA FUNCI칍N AS칈NCRONA
            obtenerTextoDeDrive(); 
        };

        // --- FUNCI칍N DE CARGA ---
        async function obtenerTextoDeDrive() {
            // ENLACE A칌ADIDO:
            const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLBHYrwNyk20UoDwqBu-zfDXWSyeRtsg536axelI0eEHYsovoMiwgoS82tjGRy6Tysw3Pj6ovDiyzo/pub?gid=1908899796&single=true&output=csv';

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const texto = await response.text();
                // console.log("Contenido recibido:", texto);
                
                // Procesamos el texto directamente
                procesarCSV(texto);
                return texto;

            } catch (error) {
                console.error("Hubo un problema al obtener el archivo:", error);
                document.getElementById('contenedor-filas').innerHTML = `
                    <div style="color: red; text-align: center; padding: 2rem;">
                        <strong>Error de carga:</strong> ${error.message}<br>
                        <small>Revisa que el enlace CSV sea p칰blico y correcto.</small>
                    </div>`;
            }
        }

        // --- PROCESAMIENTO ---
        function procesarCSV(csv) {
            const filas = csv.split('\n');
            const contenedor = document.getElementById('contenedor-filas');
            contenedor.innerHTML = '';
            
            // Reiniciar variables
            datosHorario = {};
            listaHoras = [];
            listaDias = [];

            const cabeceras = filas[0] ? filas[0].split(',').map(h => h.trim()) : [];
            const cabecerasNorm = cabeceras.map(h => normalizarTexto(h));
            
            // 칈ndices de columnas
            const idxDia = cabecerasNorm.indexOf('dia');
            const idxOrden = cabecerasNorm.indexOf('orden');
            const idxRango = cabecerasNorm.indexOf('rango');
            const idxTipo = cabecerasNorm.indexOf('tipo');
            const idxProfesor = cabecerasNorm.indexOf('profesor');
            const idxUbicacion = cabecerasNorm.indexOf('ubicacion');
            const idxTarea = cabecerasNorm.indexOf('tarea');

            for (let i = 1; i < filas.length; i++) {
                const linea = filas[i].trim();
                if (!linea) continue;
                
                // Manejo b치sico de comas
                const partes = linea.split(','); 
                
                const dia = idxDia >= 0 ? (partes[idxDia] || 'Lunes').trim() : 'Lunes';
                const orden = idxOrden >= 0 ? (partes[idxOrden] || '').trim() : '';
                const rango = idxRango >= 0 ? (partes[idxRango] || '').trim() : '';
                const tipo = idxTipo >= 0 ? (partes[idxTipo] || '').trim().toUpperCase() : 'GUARDIA';
                const profesor = idxProfesor >= 0 ? (partes[idxProfesor] || '').trim() : '';
                const ubicacion = idxUbicacion >= 0 ? (partes[idxUbicacion] || '').trim() : '';
                const tarea = idxTarea >= 0 ? (partes[idxTarea] || '').trim() : '';

                if (!orden) continue;

                if (!datosHorario[dia]) {
                    datosHorario[dia] = {};
                    listaDias.push(dia);
                }
                if (!datosHorario[dia][orden]) {
                    datosHorario[dia][orden] = { rango, guardias: [], ausencias: [] };
                    listaHoras.push({ dia, orden });
                }

                if (tipo === 'AUSENCIA') {
                    datosHorario[dia][orden].ausencias.push({ profesor, ubicacion, tarea });
                } else {
                    datosHorario[dia][orden].guardias.push({ nombre: profesor, ubi: ubicacion });
                }
            }

            // Ordenar
            listaDias.sort((a, b) => {
                const ia = ordenDias.indexOf(a);
                const ib = ordenDias.indexOf(b);
                if (ia === -1 && ib === -1) return a.localeCompare(b);
                if (ia === -1) return 1;
                if (ib === -1) return -1;
                return ia - ib;
            });

            listaHoras.sort((a, b) => {
                if (a.dia !== b.dia) return a.dia.localeCompare(b.dia);
                return parseInt(a.orden) - parseInt(b.orden);
            });

            renderizar();
            llenarSelectDias();
            llenarSelectHoras();

            const tiempoMs = performance.now() - tiempoInicioCarga;
            document.getElementById('tiempo-carga').innerText = `Carga: ${tiempoMs.toFixed(0)} ms`;
        }

        // --- RENDERIZADO ---
        function renderizar() {
            const contenedor = document.getElementById('contenedor-filas');
            contenedor.innerHTML = '';
            listaDias.forEach(dia => {
                const diaSection = document.createElement('div');
                diaSection.className = 'dia-section';
                diaSection.innerHTML = `<div class="dia-title">${dia}</div>`;
                
                const horasDelDia = Object.keys(datosHorario[dia] || {}).sort((a, b) => parseInt(a) - parseInt(b));
                
                horasDelDia.forEach(orden => {
                    const dato = datosHorario[dia][orden];
                    const diaKey = obtenerClaveDia(dia);
                    
                    let htmlProfes = '';
                    dato.guardias.forEach(p => {
                        htmlProfes += `
                            <li class="profe-item">
                                <span class="profe-icon">游녻</span>
                                <strong>${p.nombre}</strong>
                                <span class="aula-tag">${p.ubi || 'General'}</span>
                            </li>`;
                    });

                    let htmlAusencias = '';
                    if (dato.ausencias.length) {
                        dato.ausencias.forEach(a => {
                            htmlAusencias += `
                                <div class="task-card">
                                    <div class="task-header">
                                        <span class="task-profe">${a.profesor}</span>
                                        <span class="task-meta">${a.ubicacion || 'Sin aula'}</span>
                                    </div>
                                    <div class="task-body">${a.tarea || 'Sin tarea especificada'}</div>
                                </div>`;
                        });
                    }

                    const div = document.createElement('div');
                    div.className = 'hora-card';
                    div.innerHTML = `
                        <div class="col-guardias">
                            <span class="hora-badge">Hora ${orden}</span>
                            <span class="hora-rango">${dato.rango}</span>
                            <ul class="lista-profes" id="lista-guardias-${diaKey}-${orden}">
                                ${htmlProfes}
                            </ul>
                            <button class="btn-add-guardia" onclick="abrirModal('guardia', '${orden}', '${dia}')">
                                + A침adir Profesor de Guardia
                            </button>
                        </div>
                        <div class="col-ausencias" id="zona-tareas-${diaKey}-${orden}">
                            ${htmlAusencias || `<div class="empty-state" id="empty-${diaKey}-${orden}">No hay ausencias registradas</div>`}
                        </div>
                    `;
                    diaSection.appendChild(div);
                });
                contenedor.appendChild(diaSection);
            });
        }

        // --- L칍GICA DEL MODAL ---
        function llenarSelectDias() {
            const selDia = document.getElementById('input-dia');
            selDia.innerHTML = '';
            listaDias.forEach(dia => {
                const opt = document.createElement('option');
                opt.value = dia;
                opt.text = dia;
                selDia.appendChild(opt);
            });
            selDia.onchange = () => llenarSelectHoras();
        }

        function llenarSelectHoras() {
            const sel = document.getElementById('input-hora');
            sel.innerHTML = '';
            const diaSeleccionado = document.getElementById('input-dia').value;
            if (!diaSeleccionado || !datosHorario[diaSeleccionado]) return;
            
            const horasDelDia = Object.keys(datosHorario[diaSeleccionado] || {}).sort((a, b) => parseInt(a) - parseInt(b));
            horasDelDia.forEach(orden => {
                const opt = document.createElement('option');
                opt.value = orden;
                opt.text = `Hora ${orden} (${datosHorario[diaSeleccionado][orden].rango})`;
                sel.appendChild(opt);
            });
        }

        function abrirModal(modo, horaPreseleccionada = null, diaPreseleccionado = null) {
            const overlay = document.getElementById('modal');
            const titulo = document.getElementById('modal-titulo');
            const tipoInput = document.getElementById('tipo-accion');
            const selectHora = document.getElementById('input-hora');
            const selectDia = document.getElementById('input-dia');
            
            const divAusencia = document.getElementById('campos-ausencia');
            const divGuardia = document.getElementById('campos-guardia');
            
            overlay.style.display = 'flex';
            tipoInput.value = modo;

            if (diaPreseleccionado) selectDia.value = diaPreseleccionado;
            llenarSelectHoras();

            if (modo === 'ausencia') {
                titulo.innerText = "Registrar Ausencia";
                titulo.style.color = "var(--danger)";
                divAusencia.style.display = 'block';
                divGuardia.style.display = 'none';
                selectHora.disabled = false;
                selectDia.disabled = false;
            } else {
                titulo.innerText = "A침adir Profesor de Guardia";
                titulo.style.color = "var(--accent)";
                divAusencia.style.display = 'none';
                divGuardia.style.display = 'block';
                if (horaPreseleccionada) {
                    selectHora.value = horaPreseleccionada;
                    selectHora.disabled = true;
                }
                if (diaPreseleccionado) selectDia.disabled = true;
            }
        }

        function cerrarModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('input-nombre').value = '';
            document.getElementById('input-ubicacion').value = '';
            document.getElementById('input-tarea').value = '';
            document.getElementById('input-lugar-guardia').value = '';
            document.getElementById('input-hora').disabled = false;
            document.getElementById('input-dia').disabled = false;
        }

        function guardarDatos() {
            const modo = document.getElementById('tipo-accion').value;
            const dia = document.getElementById('input-dia').value;
            const hora = document.getElementById('input-hora').value;
            const nombre = document.getElementById('input-nombre').value;
            if (!nombre) return alert("Escribe el nombre del profesor");
            
            const diaKey = obtenerClaveDia(dia);
            
            if (modo === 'ausencia') {
                const ubicacion = document.getElementById('input-ubicacion').value;
                const tarea = document.getElementById('input-tarea').value;
                const zona = document.getElementById(`zona-tareas-${diaKey}-${hora}`);
                const empty = document.getElementById(`empty-${diaKey}-${hora}`);
                if (empty) empty.style.display = 'none';
                
                const card = document.createElement('div');
                card.className = 'task-card';
                card.innerHTML = `
                    <div class="task-header">
                        <span class="task-profe">${nombre}</span>
                        <span class="task-meta">${ubicacion}</span>
                    </div>
                    <div class="task-body">${tarea}</div>`;
                zona.appendChild(card);
            } else {
                const lugar = document.getElementById('input-lugar-guardia').value || 'Refuerzo';
                const lista = document.getElementById(`lista-guardias-${diaKey}-${hora}`);
                const li = document.createElement('li');
                li.className = 'profe-item';
                li.innerHTML = `
                    <span class="profe-icon">游녻</span>
                    <strong>${nombre}</strong>
                    <span class="aula-tag">${lugar}</span>`;
                lista.appendChild(li);
            }
            cerrarModal();
        }
    </script>
</body>
</html>